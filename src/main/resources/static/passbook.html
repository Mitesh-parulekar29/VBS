<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passbook - Virtual Banking System</title>

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        *{margin:0;padding:0;box-sizing:border-box}

        body{
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;
            padding:20px
        }

        .container{
            max-width:1000px;
            margin:auto;
            background:#fff;
            border-radius:16px;
            box-shadow:0 20px 60px rgba(0,0,0,.3);
            overflow:hidden
        }

        .header{
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            padding:30px;
            color:#fff;
            display:flex;
            justify-content:space-between;
            align-items:center
        }

        .header-left h1{font-size:28px}

        .btn-header{
            min-width:130px;
            height:42px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding:10px 20px;
            border:none;
            background:#667eea;
            color:#fff;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
            text-decoration:none;
            transition:.3s
        }

        .btn-header:hover{background:#5a6fdc}

        /* ‚úÖ LARGE BUTTON SAME SIZE AS BALANCE CARD */
        .btn-large{
            padding:20px 30px;
            height:auto;
            font-size:16px;
            border-radius:10px;
        }

        .header > div{display:flex;gap:10px}

        .content{padding:40px 30px}

        .passbook-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:30px
        }

        .balance-card{
            background:linear-gradient(135deg,#667eea,#764ba2);
            color:#fff;
            padding:20px 30px;
            border-radius:10px
        }

        .balance-card .amount{font-size:28px;font-weight:700}

        .transactions-section{
            background:#f8f9fa;
            padding:30px;
            border-radius:12px
        }

        .transactions-list{display:flex;flex-direction:column;gap:10px}

        .transaction-item{
            background:#fff;
            padding:18px;
            border-radius:10px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            border-left:5px solid #667eea;
            box-shadow:0 2px 8px rgba(0,0,0,.05)
        }

        .transaction-item.deposit{border-left-color:#43e97b}
        .transaction-item.withdrawal{border-left-color:#f5576c}
        .transaction-item.transfer{border-left-color:#4facfe}

        .transaction-info{display:flex;gap:15px;align-items:center}

        .transaction-icon{
            width:45px;height:45px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:22px
        }

        .deposit .transaction-icon{background:#d4f8e8;color:#43e97b}
        .withdrawal .transaction-icon{background:#fde0e5;color:#f5576c}
        .transfer .transaction-icon{background:#d4e7ff;color:#4facfe}

        .transaction-details .type{font-weight:600;color:#333}
        .transaction-details .date{font-size:12px;color:#999}

        .transaction-right{text-align:right}
        .transaction-amount{font-size:16px;font-weight:700}
        .deposit .transaction-amount{color:#43e97b}
        .withdrawal .transaction-amount{color:#f5576c}
        .transfer .transaction-amount{color:#4facfe}

        .balance-display{font-size:12px;color:#999}

        .pagination{
            margin-top:20px;
            display:flex;
            justify-content:center;
            gap:10px
        }

        .pagination button{
            padding:8px 12px;
            border:1px solid #ddd;
            border-radius:6px;
            cursor:pointer
        }

        .pagination .active{
            background:#667eea;
            color:#fff;
            border-color:#667eea
        }
    </style>
</head>

<body>
<div class="container">

    <div class="header">
        <div class="header-left">
            <h1>VBS</h1>
        </div>
        <div>
            <a id="dashLink" class="btn-header">‚Üê Dashboard</a>
            <button class="btn-header" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="content">

        <div class="passbook-header">
            <h2>Your Passbook</h2>
            <div style="display:flex;gap:15px;align-items:stretch">
                <!-- ‚úÖ SAME SIZE AS BALANCE CARD -->
                <button class="btn-header btn-large" onclick="exportPDF()">Export PDF</button>

                <div class="balance-card">
                    <p>Current Balance</p>
                    <div class="amount">‚Çπ<span id="currentBalance">0.00</span></div>
                </div>
            </div>
        </div>

        <div class="transactions-section">
            <div id="transactionsList" class="transactions-list"></div>
            <div id="paginationControls" class="pagination"></div>
        </div>

    </div>
</div>

<script>
    const API_URL='http://localhost:8081';
    let userId,role;
    let transactions=[];
    let currentPage=1;
    const itemsPerPage=10;

    function getUserIdFromURL(){
        const p=new URLSearchParams(window.location.search);
        userId=p.get('id');
        role=p.get('role')||'customer';
        if(!userId)location.href='login.html';
        dashLink.href=`dashboard.html?id=${userId}&role=${role}`;
    }

    async function loadPassbook(){
        const r=await fetch(`${API_URL}/passbook/${userId}`);
        transactions=await r.json();
        if(transactions.length)
            currentBalance.textContent=transactions[transactions.length-1].currBalance.toFixed(2);
        render();
    }

    function getType(d){
        d=d.toLowerCase();
        if(d.includes('credited'))return'deposit';
        if(d.includes('debited'))return'withdrawal';
        return'transfer';
    }

    function render(){
        const sorted=[...transactions].sort((a,b)=>new Date(b.date)-new Date(a.date));
        const totalPages=Math.ceil(sorted.length/itemsPerPage);
        const slice=sorted.slice((currentPage-1)*itemsPerPage,currentPage*itemsPerPage);

        transactionsList.innerHTML=slice.map(t=>{
            const type=getType(t.description);
            let sign='-';
            if(type==='deposit'||(type==='transfer'&&t.description.toLowerCase().includes('received')))sign='+';
            const icon=type==='deposit'?'üì•':type==='withdrawal'?'üí∏':'üîÅ';
            return`
            <div class="transaction-item ${type}">
                <div class="transaction-info">
                    <div class="transaction-icon">${icon}</div>
                    <div class="transaction-details">
                        <div class="type">${t.description}</div>
                        <div class="date">${new Date(t.date).toLocaleString('en-IN')}</div>
                    </div>
                </div>
                <div class="transaction-right">
                    <div class="transaction-amount">${sign}‚Çπ${t.amount.toFixed(2)}</div>
                    <div class="balance-display">Balance ‚Çπ${t.currBalance.toFixed(2)}</div>
                </div>
            </div>`;
        }).join('');

        paginationControls.innerHTML='';
        for(let i=1;i<=totalPages;i++)
            paginationControls.innerHTML+=`<button class="${i===currentPage?'active':''}" onclick="go(${i})">${i}</button>`;
    }

    function go(p){currentPage=p;render()}
    function logout(){location.href='home.html'}

    function exportPDF(){
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text("Virtual Banking System - Passbook",14,15);
        doc.setFontSize(12);
        doc.text(`User ID: ${userId}`,14,25);
        doc.text(`Current Balance: ‚Çπ${currentBalance.textContent}`,14,32);
        doc.text(`Generated On: ${new Date().toLocaleString('en-IN')}`,14,39);

        const rows=transactions.map(t=>[
            new Date(t.date).toLocaleString('en-IN'),
            t.description,
            `‚Çπ${t.amount.toFixed(2)}`,
            `‚Çπ${t.currBalance.toFixed(2)}`
        ]);

        doc.autoTable({
            startY:45,
            head:[["Date","Description","Amount","Balance"]],
            body:rows,
            theme:'grid',
            styles:{fontSize:10},
            headStyles:{fillColor:[102,126,234]}
        });

        doc.save(`VBS_Passbook_${userId}.pdf`);
    }

    window.onload=()=>{
        getUserIdFromURL();
        loadPassbook();
    }
</script>
</body>
</html>